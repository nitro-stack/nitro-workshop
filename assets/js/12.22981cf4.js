(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{248:function(t,e,s){t.exports=s.p+"assets/img/cors-error.8f5afbe2.jpg"},270:function(t,e,s){"use strict";s.r(e);var a=s(4),n=Object(a.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"_5-extras"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-extras"}},[t._v("#")]),t._v(" 5. Extras")]),t._v(" "),a("p",[t._v("At this point, you already have a working full-featured serverless API, well done! ðŸŽ‰")]),t._v(" "),a("p",[t._v("NestJS is a very comprehensive framework, and there could be a lot more use-cases to cover for your specific needs. I encourage you to dive into the "),a("a",{attrs:{href:"https://docs.nestjs.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("NestJS documentation"),a("OutboundLink")],1),t._v(" to learn more about the techniques and tools you can use.")]),t._v(" "),a("p",[t._v("If you have more time and feel like it, here are some extras points that I found interesting to cover, especially if you want to build enterprise apps.")]),t._v(" "),a("p",[t._v("Note that each of these extra parts is entirely independent, so you can skip to the one you are the most interested in or do them in any order ðŸ˜‰.")]),t._v(" "),a("h2",{attrs:{id:"add-data-validation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#add-data-validation"}},[t._v("#")]),t._v(" Add data validation")]),t._v(" "),a("p",[t._v("It is a best practice to check and validate any data received by an API.\nWhat do you think would happen if you call your story creation endpoint, but without providing data?")]),t._v(" "),a("p",[t._v("Let's try!")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" http://localhost:7071/api/stories -X POST -d "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n")])])]),a("p",[t._v("Whoops! A new story is created, but with our entity properties are left empty ðŸ˜±.")]),t._v(" "),a("p",[t._v("We might want to make sure a new story has its "),a("code",[t._v("animal")]),t._v(" field set and either a "),a("code",[t._v("description")]),t._v(" or an image provided.")]),t._v(" "),a("p",[t._v("Nest.js provides a built-in "),a("code",[t._v("ValidationPipe")]),t._v(" that enforces validation rules for received data payloads, thanks to annotations provided by the "),a("a",{attrs:{href:"https://github.com/typestack/class-validator",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("class-validator")]),a("OutboundLink")],1),t._v(" package.")]),t._v(" "),a("p",[t._v("To use it, you have to create a DTO ("),a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Data_transfer_object",target:"_blank",rel:"noopener noreferrer"}},[t._v("Data Transfer Object"),a("OutboundLink")],1),t._v(") class on which you will declare the validations rules using annotations.")]),t._v(" "),a("p",[t._v("First, you need to install the required packages:")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" class-validator class-transformer\n")])])]),a("p",[t._v("Then create the file "),a("code",[t._v("src/stories/story.dto.ts")]),t._v(":")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StoryDto")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  @"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("IsNotEmpty")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  animal"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  \n  @"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("IsOptional")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  description"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  \n  @"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("IsOptional")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  createdAt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("It looks like a lot like our "),a("code",[t._v("Story")]),t._v(" entity, but this time you define only properties that are expected in the request payload. That's why there is no "),a("code",[t._v("imageUrl")]),t._v(" property here: it will be set by the controller only if an image file is uploaded.")]),t._v(" "),a("p",[t._v("The annotations "),a("code",[t._v("@IsNotEmpty()")]),t._v(" and "),a("code",[t._v("@IsOptional()")]),t._v(" describe which property can be omitted and which one can be set in the payload. You can see the complete list of provided decorators "),a("a",{attrs:{href:"https://github.com/typestack/class-validator#validation-decorators",target:"_blank",rel:"noopener noreferrer"}},[t._v("here"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("p",[t._v("Now open "),a("code",[t._v("src/stories/stories.controller.ts")]),t._v(" and change the type of the "),a("code",[t._v("data")]),t._v(" parameter of your "),a("code",[t._v("POST")]),t._v(" function to "),a("code",[t._v("StoryDto")]),t._v(":")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createStory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  @"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Body")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" StoryDto"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  @"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("UploadedFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  file"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" UploadedFileMetadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("Promise")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("Story"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n")])])]),a("p",[t._v("Finally open "),a("code",[t._v("src/main.azure.ts")]),t._v(" and enable "),a("code",[t._v("ValidationPipe")]),t._v(" at the application level, to ensure all endpoints gets data validation:")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" NestFactory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("create")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("AppModule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setGlobalPrefix")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'api'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("useGlobalPipes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ValidationPipe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Start your server with "),a("code",[t._v("npm run start:azure")]),t._v(" and run the previous "),a("code",[t._v("curl")]),t._v(" command again. This time you should properly receive an HTTP error "),a("code",[t._v("400")]),t._v(" (bad request).")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("Pro tip")]),t._v(" "),a("p",[t._v("By default, detailed error messages will be automatically generated in case of a validation error. You also specify custom error message in the decorator options, for example:")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[t._v("@"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("IsNotEmpty")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" message"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'animal must not be empty'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nanimal"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("You also use special tokens in your error message or use a function for better granularity. See the "),a("a",{attrs:{href:"https://github.com/typestack/class-validator#validation-messages",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("class-validator")]),t._v(" documentation"),a("OutboundLink")],1),t._v(" for more details.")])]),t._v(" "),a("p",[t._v("What about our other constraint, which is to have either a "),a("code",[t._v("description")]),t._v(" or an image file provided?")]),t._v(" "),a("p",[t._v("Since the "),a("code",[t._v("imageUrl")]),t._v(" information is not directly part of the DTO, we cannot use it for validation. As the "),a("code",[t._v("imageUrl")]),t._v(" property is set in the controller, that's where you have to perform manual validation. You can use the "),a("a",{attrs:{href:"https://github.com/typestack/class-validator#manual-validation",target:"_blank",rel:"noopener noreferrer"}},[t._v("manual validation methods"),a("OutboundLink")],1),t._v(" of the "),a("code",[t._v("class-validator")]),t._v(" package for that.")]),t._v(" "),a("p",[t._v("This time, it's your turn to finish the job!")]),t._v(" "),a("ul",[a("li",[t._v("Ensure that either "),a("code",[t._v("description")]),t._v(" or "),a("code",[t._v("imageUrl")]),t._v(" is not empty, using manual validation.")]),t._v(" "),a("li",[t._v("Ensure that "),a("code",[t._v("description")]),t._v(" length is at most 240 characters.")]),t._v(" "),a("li",[t._v("Ensure that "),a("code",[t._v("animal")]),t._v(" is either set to "),a("code",[t._v("cat")]),t._v(", "),a("code",[t._v("doc")]),t._v(" or "),a("code",[t._v("hamster")]),t._v(" using annotations.")]),t._v(" "),a("li",[t._v("Ensure that "),a("code",[t._v("createdAt")]),t._v(" is a date if provided, using annotations.")])]),t._v(" "),a("p",[t._v("You can read more on data validation techniques in the "),a("a",{attrs:{href:"https://docs.nestjs.com/techniques/validation",target:"_blank",rel:"noopener noreferrer"}},[t._v("NestJS documentation"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("h2",{attrs:{id:"enable-cors"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#enable-cors"}},[t._v("#")]),t._v(" Enable CORS")]),t._v(" "),a("p",[t._v("If you try to access your API inside a web application from your browser, you might encounter an error like that one:")]),t._v(" "),a("p",[a("img",{attrs:{src:s(248),alt:"CORS error"}})]),t._v(" "),a("p",[t._v("This error occurs because browsers block HTTP requests from scripts to web domains different than the one of the current web page to improve security.")]),t._v(" "),a("p",[t._v("To bypass this restriction, your server must define specific HTTP headers to allow it. This mechanism is called "),a("a",{attrs:{href:"https://developer.mozilla.org/docs/Web/HTTP/CORS",target:"_blank",rel:"noopener noreferrer"}},[t._v("Cross-Origin Resource Sharing"),a("OutboundLink")],1),t._v(" (CORS).")]),t._v(" "),a("p",[t._v("CORS is already enabled by default on Azure Functions but you must add your website domain to the list of allowed origins using this command:")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("# Don't forget to change the name and URL with your own\n$ az functionapp cors add \\\n    --name funpets-api \\\n    --resource-group funpets \\\n    --allowed-origins https://yourwebsite.com\n")])])]),a("p",[t._v("If you want to allow any website to use your API, you can replace the website URL by using "),a("code",[t._v("*")]),t._v(" instead. In that case, be careful as Azure Functions will auto-scale to handle the workload if millions of users start using it, but so will your bill!")]),t._v(" "),a("h2",{attrs:{id:"enable-authorization"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#enable-authorization"}},[t._v("#")]),t._v(" Enable authorization")]),t._v(" "),a("p",[t._v("By default, all Azure Functions triggered by HTTP are publicly available. It's useful for a lot of scenarios, but at some point you might want to restrict who can execute your functions, in our case your API.")]),t._v(" "),a("p",[t._v("Open the file "),a("code",[t._v("main/function.json")]),t._v(". In the functions, bindings, notice that "),a("code",[t._v("authLevel")]),t._v(" is set to "),a("code",[t._v("anonymous")]),t._v(". It can be set to one of these 3 values:")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("anonymous")]),t._v(": no API key is required (default).")]),t._v(" "),a("li",[a("code",[t._v("function")]),t._v(": an API key specific to this function is required. If none is defined, the "),a("code",[t._v("default")]),t._v(" one will be used.")]),t._v(" "),a("li",[a("code",[t._v("admin")]),t._v(": a host API key is required. It will be shared among all functions from the same app.")])]),t._v(" "),a("p",[t._v("Now change "),a("code",[t._v("authLevel")]),t._v(" to "),a("code",[t._v("function")]),t._v(", and redeploy your function:")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Don't forget to change the name with the one you used previously")]),t._v("\nfunc azure functionapp publish "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("your-funpets-api"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" --nozip\n")])])]),a("p",[t._v("Then try to invoke again your API:")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" https://"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("your-funpets-api"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(".azurewebsites.net/api/stories -i\n")])])]),a("p",[t._v("You should get an HTTP status "),a("code",[t._v("401")]),t._v(" error ("),a("code",[t._v("Unauthorized")]),t._v(").")]),t._v(" "),a("p",[t._v("To call a protected function, you need to either provide the key as a query string parameter in the form "),a("code",[t._v("code=<api_key>")]),t._v(" or you can provide it with the HTTP header "),a("code",[t._v("x-functions-key")]),t._v(".")]),t._v(" "),a("p",[t._v("You can either log in to "),a("a",{attrs:{href:"https://portal.azure.com?WT.mc_id=nitro-workshop-yolasors",target:"_blank",rel:"noopener noreferrer"}},[t._v("portal.azure.com"),a("OutboundLink")],1),t._v(" and go to your function app, or follow these steps to retrieve your function API keys:")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("// Retrieve your resource ID\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Don't forget to change the name with the one you used previously")]),t._v("\naz functionapp show --name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("your-funpets-api"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n                    --resource-group funpets "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n                    --query "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Use the resource ID from the previous command")]),t._v("\naz rest --method post --uri "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<resource_id>/host/default/listKeys?api-version=2018-11-01"')]),t._v("\n")])])]),a("p",[t._v("You should see something like that:")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"functionKeys"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"default"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"functionApiKey=="')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"masterKey"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"masterApiKey=="')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"systemKeys"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("Then try to invoke again your API, this time with the "),a("code",[t._v("x-functions-key")]),t._v(" header set with your function API key:")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" https://"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("your-funpets-api"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(".azurewebsites.net/api/stories -i "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -H "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"x-functions-key: <your_function_api_key>"')]),t._v("\n")])])]),a("p",[t._v("This time the call should succeed!")]),t._v(" "),a("p",[t._v("Using authorization level you can restrict who can call your API, this can be useful especially for service-to-service access restrictions.")]),t._v(" "),a("p",[t._v("However, if you need to manage finely who can access your API with an endpoint granularity, you need to implement "),a("a",{attrs:{href:"https://docs.nestjs.com/techniques/authentication",target:"_blank",rel:"noopener noreferrer"}},[t._v("authentication"),a("OutboundLink")],1),t._v(" in your app.")]),t._v(" "),a("h2",{attrs:{id:"write-tests"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#write-tests"}},[t._v("#")]),t._v(" Write tests")]),t._v(" "),a("p",[t._v("Your API might currently look fine, but how can you ensure it has as little bugs as possible, and that you won't introduce regression in the future?")]),t._v(" "),a("p",[t._v("Writing automated is not the most fun part of development, but it's a fundamental requirement to develop robust software applications. It helps to catch bugs early, preventing regressions and ensuring that production releases meet your quality and performance goals.")]),t._v(" "),a("p",[t._v("The good news is NestJS has you covered to make your testing experience as smooth as possible.\nWhen you bootstrapped the project using the "),a("code",[t._v("nest")]),t._v(" CLI, "),a("a",{attrs:{href:"https://jestjs.io",target:"_blank",rel:"noopener noreferrer"}},[t._v("Jest"),a("OutboundLink")],1),t._v(" and "),a("a",{attrs:{href:"https://github.com/visionmedia/supertest",target:"_blank",rel:"noopener noreferrer"}},[t._v("SuperTest"),a("OutboundLink")],1),t._v(" frameworks have been set up for you.")]),t._v(" "),a("p",[t._v("Each time you run the "),a("code",[t._v("nest generate")]),t._v(" command, unit test files are also created for you with the extension "),a("code",[t._v(".spec.ts")]),t._v(".")]),t._v(" "),a("p",[t._v("There are 5 NPM scripts dedicated to testing in your "),a("code",[t._v("package.json")]),t._v(" file:")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("npm test")]),t._v(": runs unit tests once.")]),t._v(" "),a("li",[a("code",[t._v("npm run test:watch")]),t._v(" runs unit tests in watch mode, it will automatically re-run tests as you make modifications to the files. It is suited perfectly for "),a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Test-driven_development",target:"_blank",rel:"noopener noreferrer"}},[t._v("TDD"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("li",[a("code",[t._v("npm run test:cov")]),t._v(" runs unit tests and generate coverage report, so you can know which code paths are covered by your tests.")]),t._v(" "),a("li",[a("code",[t._v("npm run test:debug")]),t._v(": runs unit tests with Node.js debugger enabled, so you can add breakpoints in your code editor and debug your tests more easily.")]),t._v(" "),a("li",[a("code",[t._v("npm run test:e2e")]),t._v(": runs your end-to-end tests.")])]),t._v(" "),a("p",[t._v("Now run the "),a("code",[t._v("npm test")]),t._v(" command. Oops, it seems that "),a("code",[t._v("src/stories/stories.controller.spec.ts")]),t._v(" test if failing ðŸ˜±!")]),t._v(" "),a("h3",{attrs:{id:"add-module-and-providers-mocks"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#add-module-and-providers-mocks"}},[t._v("#")]),t._v(" Add module and providers mocks")]),t._v(" "),a("p",[t._v("If you look at the stack trace, you can see that the reason is that "),a("code",[t._v("@nestjs/typeorm")]),t._v(" and "),a("code",[t._v("AzureStorageModule")]),t._v(" services cannot be resolved. It's expected: when running unit tests, you want to isolate the code you are testing as much as possible, and for that you can see that each test file provides its own module definition:")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("beforeEach")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("module")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" TestingModule "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" Test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createTestingModule")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    controllers"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("StoriesController"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("compile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  controller "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("module")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("StoriesController"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("StoriesController"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("The module created with "),a("code",[t._v("Test.createTestingModule")]),t._v(" does not import "),a("code",[t._v("AzureTableStorageModule")]),t._v(" and "),a("code",[t._v("AzureStorageModule")]),t._v(", so that's why their providers cannot be resolved. Instead of importing them right away to fix the issue, we should write "),a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Mock_object",target:"_blank",rel:"noopener noreferrer"}},[a("strong",[t._v("mocks")]),a("OutboundLink")],1),t._v(" for the providers we use instead.")]),t._v(" "),a("h4",{attrs:{id:"mock-nestjs-azure-storage"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mock-nestjs-azure-storage"}},[t._v("#")]),t._v(" Mock "),a("code",[t._v("@nestjs/azure-storage")])]),t._v(" "),a("p",[t._v("Let's start with mocking what we use in "),a("code",[t._v("@nestjs/azure-storage")]),t._v(" module, using "),a("code",[t._v("jest.mock(<module>)")]),t._v(" helper function. Add this code just after the imports:")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[t._v("jest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mock")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@nestjs/azure-storage'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Use Jest automatic mock generation")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("jest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("genMockFromModule")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@nestjs/azure-storage'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Mock interceptor")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("AzureStorageFileInterceptor")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    intercept"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" jest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" next"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("handle")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("For simple modules, using "),a("code",[t._v("jest.mock(<module>)")]),t._v(" would be enough to generate mocks automatically according to the module interface.")]),t._v(" "),a("p",[t._v("But in our case, "),a("code",[t._v("AzureStorageFileInterceptor")]),t._v(" needs to be mocked manually as it is a bit trickier: it must returns an object with a method "),a("code",[t._v("intercept(context, next)")]),t._v(" that needs to call "),a("code",[t._v("next.handle()")]),t._v(" to not break the chain of interceptors calls.")]),t._v(" "),a("p",[t._v("So we provide our own version of the "),a("code",[t._v("@nestjs/azure-storage")]),t._v(" module mock, using "),a("code",[t._v("jest.genMockFromModule(<module>)")]),t._v(" helper to automatically generates mocks for everything except "),a("code",[t._v("AzureStorageFileInterceptor")]),t._v(".")]),t._v(" "),a("p",[t._v("For "),a("code",[t._v("AzureStorageFileInterceptor")]),t._v(" we manually reproduce a minimal implementation. Using "),a("code",[t._v("jest.fn()")]),t._v(" method here creates a "),a("a",{attrs:{href:"https://jestjs.io/docs/en/mock-function-api",target:"_blank",rel:"noopener noreferrer"}},[t._v("mock function"),a("OutboundLink")],1),t._v(". Thanks to that, we can later change its implementation in a specific test if needed.")]),t._v(" "),a("p",[t._v("Then add "),a("code",[t._v("AzureStorageService")]),t._v(" to the testting module "),a("code",[t._v("providers")]),t._v(" list:")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("beforeEach")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("module")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" TestingModule "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" Test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createTestingModule")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    controllers"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("StoriesController"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    providers"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("AzureStorageService"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("compile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  controller "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("module")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("StoriesController"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("StoriesController"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("And complete the missing import:")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" AzureStorageService "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@nestjs/azure-storage'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h4",{attrs:{id:"mock-nestjs-typeorm"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mock-nestjs-typeorm"}},[t._v("#")]),t._v(" Mock "),a("code",[t._v("@nestjs/typeorm")])]),t._v(" "),a("p",[t._v("We also need to mock the "),a("code",[t._v("storiesRepository")]),t._v(" service injected in our controller using "),a("code",[t._v("@InjectRepository(Story)")]),t._v(", but how to do that?")]),t._v(" "),a("p",[t._v("This time we do not need to mock the entire module, but only this specific service.\nWe can still use Jest automatic mock generation:")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Add this code after the imports")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" mockRepository "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" jest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("genMockFromModule"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("any")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'typeorm'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MongoRepository"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Its injection token is generated dynamically, so we need to add a "),a("a",{attrs:{href:"https://docs.nestjs.com/fundamentals/custom-providers#custom-providers-1",target:"_blank",rel:"noopener noreferrer"}},[t._v("custom provider"),a("OutboundLink")],1),t._v(" to our testing module to reproduce the same behavior:")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("beforeEach")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("module")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" TestingModule "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" Test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createTestingModule")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    controllers"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("StoriesController"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      providers"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        AzureStorageService"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" provide"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getRepositoryToken")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Story"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" useValue"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" mockRepository "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("compile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  controller "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("module")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("StoriesController"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("StoriesController"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("Pro tip")]),t._v(" "),a("p",[t._v("We had to look at the implementation "),a("code",[t._v("@InjectRepository()")]),t._v(" annotation to find out that it uses the method "),a("code",[t._v("getRepositoryToken()")]),t._v(" internally. Unfortunately, that's something you have to do sometimes to be able to mock modules properly.")])]),t._v(" "),a("p",[t._v("Don't forget to add missing imports:")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" getRepositoryToken "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@nestjs/typeorm'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Story "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./story.entity'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Now run "),a("code",[t._v("npm test")]),t._v(" again, this time the tests should succeed!")]),t._v(" "),a("h3",{attrs:{id:"complete-test-suite"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#complete-test-suite"}},[t._v("#")]),t._v(" Complete test suite")]),t._v(" "),a("p",[t._v("Hold on, now that we have solved the mock issue, it's time to write more tests ðŸ˜ƒ!")]),t._v(" "),a("p",[t._v("Try to add:")]),t._v(" "),a("ul",[a("li",[t._v("Unit tests for your controller in "),a("code",[t._v("src/stories/stories.controller.ts")]),t._v(".")]),t._v(" "),a("li",[t._v("An end-to-end for of your endpoints in "),a("code",[t._v("tests/app.e2e-spec.ts")]),t._v(".")])]),t._v(" "),a("p",[t._v("Take also a look a the report generated by "),a("code",[t._v("npm run test:cov")]),t._v(" to see your test coverage.")]),t._v(" "),a("p",[t._v("If you are not familiar with Jest you might want to take a look at the "),a("a",{attrs:{href:"https://jestjs.io/docs/en/using-matchers",target:"_blank",rel:"noopener noreferrer"}},[t._v("documentation"),a("OutboundLink")],1),t._v(".\nFor end-to-end tests, HTTP assertions are made using the "),a("a",{attrs:{href:"https://github.com/visionmedia/supertest",target:"_blank",rel:"noopener noreferrer"}},[t._v("SuperTest library"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("p",[t._v("You can also find examples and more information in the "),a("a",{attrs:{href:"https://docs.nestjs.com/fundamentals/testing#unit-testing",target:"_blank",rel:"noopener noreferrer"}},[t._v("NestJS documentation"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("br"),t._v(" "),a("hr"),t._v(" "),a("p",[a("strong",[t._v("Solution:")]),t._v(" see the "),a("a",{attrs:{href:"https://github.com/nitro-stack/nitro-workshop/tree/step5",target:"_blank",rel:"noopener noreferrer"}},[t._v("code for extras"),a("OutboundLink")],1)])])}),[],!1,null,null,null);e.default=n.exports}}]);