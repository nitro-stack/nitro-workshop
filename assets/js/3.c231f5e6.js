(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{211:function(t,s,e){t.exports=e.p+"assets/img/try2.d2076d4c.png"},248:function(t,s,e){t.exports=e.p+"assets/img/cosmos-db.f635c65e.png"},249:function(t,s,e){t.exports=e.p+"assets/img/try1.d2bea64c.png"},250:function(t,s,e){t.exports=e.p+"assets/img/try3.d40b54e3.png"},251:function(t,s,e){t.exports=e.p+"assets/img/try4.c954a03e.png"},252:function(t,s,e){t.exports=e.p+"assets/img/try5.bd45ed70.png"},253:function(t,s,e){t.exports=e.p+"assets/img/try-explorer.9ef0237a.png"},254:function(t,s,e){t.exports=e.p+"assets/img/cosmos-portal.dba52ccd.png"},255:function(t,s,e){t.exports=e.p+"assets/img/cosmos-explorer.2c355978.png"},270:function(t,s,e){"use strict";e.r(s);var a=e(4),n=Object(a.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"_3-add-database"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-add-database"}},[t._v("#")]),t._v(" 3. Add database")]),t._v(" "),a("p",[t._v("Now that we have everything set up for our application code and deployment, we can go on with the more serious stuff and add a database instead of using hardcoded data.")]),t._v(" "),a("h2",{attrs:{id:"configure-cosmos-db"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#configure-cosmos-db"}},[t._v("#")]),t._v(" Configure Cosmos DB")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://azure.microsoft.com/services/cosmos-db/?WT.mc_id=nitro-workshop-yolasors",target:"_blank",rel:"noopener noreferrer"}},[t._v("Cosmos DB"),a("OutboundLink")],1),t._v(" is a managed distributed NoSQL database that will allow you to save and retrieve data. It supports multiple data models and many well known database APIs, including "),a("a",{attrs:{href:"https://www.mongodb.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("MongoDB"),a("OutboundLink")],1),t._v(" that we will use for our application.")]),t._v(" "),a("p",[a("img",{attrs:{src:e(248),alt:"CosmosDB multi-model and different APIs illustration"}})]),t._v(" "),a("p",[t._v("First we have to create a Cosmos DB account, which can hold one or more databases.")]),t._v(" "),a("p",[t._v("If you are attending this workshop with an instructor or if you are short on time, you should use the first option "),a("strong",[t._v("Use trial account")]),t._v(". The second option allows you to create a new account, which is a bit longer.")]),t._v(" "),a("tabs",{attrs:{options:{useUrlFragment:!1}}},[a("tab",{attrs:{name:"Use trial account"}},[a("p",[t._v("The quickest way to experiment with Cosmos DB is to use the "),a("a",{attrs:{href:"https://azure.microsoft.com/try/cosmosdb/?WT.mc_id=nitro-workshop-yolasors",target:"_blank",rel:"noopener noreferrer"}},[t._v("Try CosmosDB for free"),a("OutboundLink")],1),t._v(" website, to get instant access to a pre-provisionned free account for 30 days (renewable).")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("Open the "),a("a",{attrs:{href:"https://azure.microsoft.com/try/cosmosdb/?WT.mc_id=nitro-workshop-yolasors",target:"_blank",rel:"noopener noreferrer"}},[t._v("Try CosmosDB for free"),a("OutboundLink")],1),t._v(" website, then click on the MongoDB "),a("strong",[t._v("Create")]),t._v(" option:")]),t._v(" "),a("p",[a("img",{attrs:{src:e(249),alt:"mongoDB database creation option"}})])]),t._v(" "),a("li",[a("p",[t._v("Log in if needed, then once the database is ready click on the button "),a("strong",[t._v("Open in Azure Portal")]),t._v(":")]),t._v(" "),a("p",[a("img",{attrs:{src:e(211),alt:"open in Azure Portal button"}})])]),t._v(" "),a("li",[a("p",[t._v("Click on the "),a("strong",[t._v("Data Explorer")]),t._v(" tab, then on the "),a("strong",[t._v("New Collection")]),t._v(" button:")]),t._v(" "),a("p",[a("img",{attrs:{src:e(250),alt:"screenshot of data explorer"}})])]),t._v(" "),a("li",[a("p",[t._v("Fill in the fields like this:")]),t._v(" "),a("p",[a("img",{attrs:{src:e(251),alt:"screenshot of new collection creation"}})]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("Pro tip")]),t._v(" "),a("p",[t._v("There are two things worth mentioning here:")]),t._v(" "),a("ul",[a("li",[t._v("We choose to share a provisioned throughput of "),a("a",{attrs:{href:"https://docs.microsoft.com/azure/cosmos-db/request-units?WT.mc_id=nitro-workshop-yolasors",target:"_blank",rel:"noopener noreferrer"}},[t._v("Request Units"),a("OutboundLink")],1),t._v(" among all our collections within our database, using the checkbox "),a("code",[t._v("Provision database throughput")]),t._v(". This greatly helps to reduce costs when using a paid account.")]),t._v(" "),a("li",[t._v("We need to define a shard key (also called "),a("a",{attrs:{href:"https://docs.microsoft.com/azure/cosmos-db/partitioning-overview?WT.mc_id=nitro-workshop-yolasors#choose-partitionkey",target:"_blank",rel:"noopener noreferrer"}},[t._v("partition key"),a("OutboundLink")],1),t._v(") for the collection, to ensure proper "),a("a",{attrs:{href:"https://docs.microsoft.com/azure/cosmos-db/partitioning-overview?WT.mc_id=nitro-workshop-yolasors",target:"_blank",rel:"noopener noreferrer"}},[t._v("partitioning"),a("OutboundLink")],1),t._v(". We use the default auto-generated "),a("code",[t._v("_id")]),t._v(" property by MongoDB for that.")])])])]),t._v(" "),a("li",[a("p",[t._v("Finally, go to the "),a("code",[t._v("Connection strings")]),t._v(" tab and click on the button next to your primary connection string to copy it:")]),t._v(" "),a("p",[a("img",{attrs:{src:e(252),alt:"Screenshot of connection strings"}})])])])]),t._v(" "),a("tab",{attrs:{name:"Create new account"}},[a("div",{staticClass:"custom-block info"},[a("p",{staticClass:"custom-block-title"},[t._v("Note")]),t._v(" "),a("p",[t._v("There is now a Free Tier for Cosmos DB that includes 5 GB storage and up to 25 collections, with production-grade performance and no expiration period (it's "),a("em",[t._v("free forever")]),t._v("!). If you want to use it, you need to create your Cosmos DB account using the "),a("a",{attrs:{href:"https://ms.portal.azure.com/?WT.mc_id=nitro-workshop-yolasors#create/Microsoft.DocumentDB",target:"_blank",rel:"noopener noreferrer"}},[t._v("Azure Portal"),a("OutboundLink")],1),t._v(" instead of running the CLI command below (choose "),a("strong",[t._v("MongoDB")]),t._v(" for the API).")])]),t._v(" "),a("p",[t._v("We will use the Azure CLI command to create our new Cosmos DB account:")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Create a Cosmos DB account")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# This name must be globally unique, so change it with your own")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# This takes around ~10 min, so you can move on to the integration")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# step meanwhile")]),t._v("\naz cosmosdb create --name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("your-funpets-cosmos"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n                   --resource-group funpets "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n                   --kind MongoDB\n")])])]),a("p",[t._v("Once the account is created, we need do three more things before switching back to code:")]),t._v(" "),a("ol",[a("li",[t._v("Create the MongoDB database.")])]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Don't forget to change the account name with the one you used previously")]),t._v("\naz cosmosdb mongodb database create --account-name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("your-funpets-cosmos"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n                                    --resource-group funpets "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n                                    --throughput "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("400")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n                                    --name funpets-db\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("Pro tip")]),t._v(" "),a("p",[t._v("We choose to share a provisioned throughput of "),a("a",{attrs:{href:"https://docs.microsoft.com/azure/cosmos-db/request-units?WT.mc_id=nitro-workshop-yolasors",target:"_blank",rel:"noopener noreferrer"}},[t._v("Request Units"),a("OutboundLink")],1),t._v(" among all our collections within our database, using the "),a("code",[t._v("--throughput")]),t._v(" option. This greatly helps to reduce costs.")])]),t._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[t._v("Create the "),a("code",[t._v("stories")]),t._v(" collection, where we will put our data.")])]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Don't forget to change the account name with the one you used previously")]),t._v("\naz cosmosdb mongodb collection create --account-name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("your-funpets-cosmos"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n                                      --resource-group funpets "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n                                      --database-name funpets-db "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n                                      --name stories "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n                                      --shard _id\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("Pro tip")]),t._v(" "),a("p",[t._v("We need to define a shard key (also called "),a("a",{attrs:{href:"https://docs.microsoft.com/azure/cosmos-db/partitioning-overview?WT.mc_id=nitro-workshop-yolasors#choose-partitionkey",target:"_blank",rel:"noopener noreferrer"}},[t._v("partition key"),a("OutboundLink")],1),t._v(") for the collection, to ensure proper "),a("a",{attrs:{href:"https://docs.microsoft.com/azure/cosmos-db/partitioning-overview?WT.mc_id=nitro-workshop-yolasors",target:"_blank",rel:"noopener noreferrer"}},[t._v("partitioning"),a("OutboundLink")],1),t._v(". We use the default auto-generated "),a("code",[t._v("_id")]),t._v(" property by MongoDB for that.")])]),t._v(" "),a("ol",{attrs:{start:"3"}},[a("li",[t._v("Finally, we retrieve the connection string to connect our application to the database.")])]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Don't forget to change the account name with the one you used previously")]),t._v("\naz cosmosdb keys list --name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("your-funpets-cosmos"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n                      --resource-group funpets "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n                      --type connection-strings "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n                      --query "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"connectionStrings[0].connectionString"')]),t._v("\n")])])])])],1),t._v(" "),a("p",[t._v("Now edit the file "),a("code",[t._v("local.settings.json")]),t._v(", and add these properties to the "),a("code",[t._v("Values")]),t._v(" list:")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"MONGODB_CONNECTION_STRING"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<your primary connection string>"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"MONGODB_DATABASE"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"funpets-db"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n")])])]),a("p",[t._v("Remove this line as it's not needed:")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"AzureWebJobsStorage"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n")])])]),a("p",[t._v("These values will be exposed to our app as "),a("strong",[t._v("environment variables")]),t._v(" by the Functions runtime, to allow access to your database.")]),t._v(" "),a("h2",{attrs:{id:"integrate-with-nestjs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#integrate-with-nestjs"}},[t._v("#")]),t._v(" Integrate with NestJS")]),t._v(" "),a("p",[t._v("You are now ready to use the database in your application. NestJS provides a great integration with "),a("a",{attrs:{href:"https://typeorm.io",target:"_blank",rel:"noopener noreferrer"}},[t._v("TypeORM"),a("OutboundLink")],1),t._v(" which is the most mature Object Relational Mapper (ORM) available for TypeScript, so we will use that.")]),t._v(" "),a("p",[t._v("First, you have to install the a few more packages with this command:")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" --save @nestjs/typeorm typeorm mongodb\n")])])]),a("p",[t._v("Open the file "),a("code",[t._v("src/app.module.ts")]),t._v(" and add "),a("code",[t._v("TypeOrmModule")]),t._v(" to the module imports:")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[t._v("@"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Module")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  imports"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    TypeOrmModule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("forRoot")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mongodb'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      url"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("MONGODB_CONNECTION_STRING")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      database"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("MONGODB_DATABASE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      entities"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        __dirname "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/**/*.entity{.ts,.js}'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      ssl"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      useUnifiedTopology"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      useNewUrlParser"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("p",[t._v("Don't forget to add the missing import at the top:")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" TypeOrmModule "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@nestjs/typeorm'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("Pro tip")]),t._v(" "),a("p",[t._v("Using "),a("code",[t._v("process.env.<VARIABLE_NAME>")]),t._v(" in place of hardcoded values allows to keep sensitive informations out of your code base and read them from environment variables instead. This also allows you to deploy the exact same code on different environments (like staging and production for example), but with different configurations, as recommend in the "),a("a",{attrs:{href:"https://12factor.net/config",target:"_blank",rel:"noopener noreferrer"}},[t._v("12-factor app"),a("OutboundLink")],1),t._v(" best practices.")])]),t._v(" "),a("p",[t._v("TypeORM will discover and map your entities following the "),a("code",[t._v("*.entity.ts")]),t._v(" ("),a("code",[t._v(".js")]),t._v(" once compiled) naming scheme, as specified in the module options.")]),t._v(" "),a("p",[t._v("But hey, we don't have an entity yet? That's right, let's create it!")]),t._v(" "),a("h2",{attrs:{id:"create-an-entity"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-an-entity"}},[t._v("#")]),t._v(" Create an entity")]),t._v(" "),a("p",[t._v("A database entity is used to model the properties of whatever object you would like to store. In our case, we would like to store fun pets stories, so let's create define a "),a("code",[t._v("Story")]),t._v(" entity.")]),t._v(" "),a("p",[t._v("Create a new file "),a("code",[t._v("src/stories/story.entity.ts")]),t._v(" with this code:")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Entity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ObjectID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ObjectIdColumn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Column "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'typeorm'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n@"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Entity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'stories'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Story")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  @"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ObjectIdColumn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ObjectID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  @"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Column")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" animal"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  @"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Column")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" description"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  @"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Column")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" imageUrl"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  @"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Column")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" createdAt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("constructor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("story"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Partial"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("Story"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    Object"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("assign")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" story"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("Now let's break down the annotations we have used:")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("@Entity")]),t._v(" marks the class as a TypeORM entity to be stored into the "),a("code",[t._v("stories")]),t._v(" collection.")]),t._v(" "),a("li",[a("code",[t._v("@ObjectIdColumn")]),t._v(" marks the unique identifier of an entity that will be mapped to the mandatory MongoDB "),a("code",[t._v("_id")]),t._v(" property. It will be automatically generated if you don't provide one.")]),t._v(" "),a("li",[a("code",[t._v("@Column")]),t._v(" marks the properties you want to map to a table column. The type of property will also define the type of data that will be stored.")])]),t._v(" "),a("div",{staticClass:"custom-block info"},[a("p",{staticClass:"custom-block-title"},[t._v("Note")]),t._v(" "),a("p",[t._v("For more complex domain models you can define subdocuments using simple type references, see "),a("a",{attrs:{href:"https://typeorm.io/#/mongodb/defining-subdocuments-embed-documents",target:"_blank",rel:"noopener noreferrer"}},[t._v("this example"),a("OutboundLink")],1),t._v(" for usage information.")])]),t._v(" "),a("h2",{attrs:{id:"inject-the-repository"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#inject-the-repository"}},[t._v("#")]),t._v(" Inject the repository")]),t._v(" "),a("p",[t._v("TypeORM supports the "),a("a",{attrs:{href:"https://docs.microsoft.com/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design?WT.mc_id=nitro-workshop-yolasors#the-repository-pattern",target:"_blank",rel:"noopener noreferrer"}},[t._v("repository design pattern"),a("OutboundLink")],1),t._v(", and "),a("code",[t._v("@nestjs/typeorm")]),t._v(" package provides you an easy way to declare repositories you can inject for each of your entities.")]),t._v(" "),a("p",[t._v("Open the file "),a("code",[t._v("src/app.module.ts")]),t._v(" again and add this to the module imports:")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[t._v("@"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Module")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  imports"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    TypeOrmModule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("forFeature")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Story"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("p",[t._v("Now you can inject your "),a("code",[t._v("Story")]),t._v(" repository using the annotation "),a("code",[t._v("@InjectRepository")]),t._v(". Open the file "),a("code",[t._v("src/stories/stories.controller.ts")]),t._v(" and add this constructor:")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[t._v("@"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Controller")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'stories'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StoriesController")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("constructor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("@"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("InjectRepository")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Story"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("readonly")]),t._v(" storiesRepository"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" MongoRepository"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("Story"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")])]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("Don't forget to add these missing imports at the top of the file:")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" InjectRepository "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@nestjs/typeorm'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" MongoRepository "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'typeorm'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" ObjectID "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mongodb'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Story "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./story.entity'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("You can now use "),a("code",[t._v("this.storiesRepositoy")]),t._v(" within your controller to perform CRUD operations:")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("save(entity: PartialEntity<Entity> | PartialEntity<Entity>[], options?: SaveOptions): Promise<Entity | Entity[]>")]),t._v(": inserts one or more entities in the database if they do not exists, updates otherwise.")]),t._v(" "),a("li",[a("code",[t._v("findOne(criteria?: ObjectID | FindOneOptions<Entity>): Promise<Entity | undefined>")]),t._v(": finds the first entity matching an ID or query options.")]),t._v(" "),a("li",[a("code",[t._v("find(criteria?: FindManyOptions<Entity>): Promise<Entity[]>")]),t._v(": finds all entities that match the specified criteria (return all entities if none is provided).")]),t._v(" "),a("li",[a("code",[t._v("update(criteria: ObjectID | ObjectID[] | FindConditions<Entity>, partialEntity: PartialEntity<Entity> | PartialEntity<Entity>[]): Promise<UpdateResult>")]),t._v(": updates entities matching the specified criteria. It allows partial updates, but does not check if entities exists.")]),t._v(" "),a("li",[a("code",[t._v("delete(criteria: ObjectID | ObjectID[] | FindConditions<Entity>): Promise<DeleteResult>")]),t._v(": removes one or more entities matching the specified criteria from the database. Does not check if entities exists.")])]),t._v(" "),a("p",[t._v("In all these methods, you can either use the entity ID or a regular "),a("a",{attrs:{href:"https://docs.mongodb.com/manual/tutorial/query-documents/",target:"_blank",rel:"noopener noreferrer"}},[t._v("MongoDB query"),a("OutboundLink")],1),t._v(" to match specific entities. For example, you can use:")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Find all cats stories")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("storiesRepository"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("find")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" animal"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'cat'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Find the story with the specified ID")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("storiesRepository"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("findOne")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h2",{attrs:{id:"add-new-endpoints"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#add-new-endpoints"}},[t._v("#")]),t._v(" Add new endpoints")]),t._v(" "),a("p",[t._v("Now you have everything needed to create new endpoints to create and get stories:")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("GET /stories/:id  // Get the story with the specified ID\nGET /stories      // Get all stories\nPOST /stories     // Create a new story\n")])])]),a("p",[t._v("Let's start with the first one, to retrieve a single story using its ID.\nAdd this method to your controller:")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[t._v("@"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("':id'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getStory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("@"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Param")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'id'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("Promise")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("Story"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" story "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ObjectID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("isValid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("storiesRepository"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("findOne")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("story"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Entity not found")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NotFoundException")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" story"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("We use the "),a("code",[t._v("@Get()")]),t._v(" annotation like in "),a("RouterLink",{attrs:{to:"/step1.html#Add-your-first-endpoint"}},[t._v("Step 1")]),t._v(", but this time we add a "),a("a",{attrs:{href:"https://docs.nestjs.com/controllers#route-parameters",target:"_blank",rel:"noopener noreferrer"}},[t._v("route parameter"),a("OutboundLink")],1),t._v(" using "),a("code",[t._v(":id")]),t._v(".\nThis parameter can then be retrieved with the function arguments using the "),a("code",[t._v("@Param('id')")]),t._v(" annotation.")],1),t._v(" "),a("p",[t._v("Then we call the "),a("code",[t._v("storiesRepository.findOne()")]),t._v(" method to find the matching entity. In case it's not found or if provided ID is invalid, we return a status "),a("code",[t._v("404")]),t._v(" error using NestJS predefined exception class "),a("code",[t._v("NotFoundException")]),t._v(".")]),t._v(" "),a("p",[t._v("After that, it's time for you to work a bit by yourself to add the 2 remaining endpoints 😉.")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("Note")]),t._v(" "),a("p",[t._v("For the create endpoint, if the property "),a("code",[t._v("createdAt")]),t._v(" is not set, it should be added with the current date.")])]),t._v(" "),a("p",[t._v("If you're stuck, you may find some help in the "),a("a",{attrs:{href:"https://docs.nestjs.com/controllers#full-resource-sample",target:"_blank",rel:"noopener noreferrer"}},[t._v("NestJS documentation"),a("OutboundLink")],1),t._v(" and the "),a("a",{attrs:{href:"https://typeorm.io/#/repository-api/repository-api",target:"_blank",rel:"noopener noreferrer"}},[t._v("TypeORM documentation"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("h2",{attrs:{id:"test-your-endpoints"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#test-your-endpoints"}},[t._v("#")]),t._v(" Test your endpoints")]),t._v(" "),a("p",[t._v("After you finished adding the new endpoints, start your server using the functions emulator:")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" run start:azure\n")])])]),a("p",[t._v("When the server is started, you can test if your new endpoints behave correctly using "),a("code",[t._v("curl")]),t._v(":")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" http://localhost:7071/api/stories\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# should return an empty list: []")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" http://localhost:7071/api/stories/0\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# should return 404 with an error")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" http://localhost:7071/api/stories "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -X POST "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -H "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"content-type: application/json"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -d "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{ "animal": "cat", "description": "Cats have supersonic hearing" }\'')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# should return the newly created story")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" http://localhost:7071/api/stories\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# should return a list with the previously added story")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" http://localhost:7071/api/stories/"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("id_from_post_command"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# should return this single story")]),t._v("\n")])])]),a("h2",{attrs:{id:"explore-your-data"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#explore-your-data"}},[t._v("#")]),t._v(" Explore your data")]),t._v(" "),a("p",[t._v("As you should have created some stories at this point, why not take a look at the data you have directly in the database?")]),t._v(" "),a("p",[t._v("You can either use the standalone "),a("a",{attrs:{href:"https://azure.microsoft.com/features/storage-explorer/?WT.mc_id=nitro-workshop-yolasors",target:"_blank",rel:"noopener noreferrer"}},[t._v("Storage Explorer application"),a("OutboundLink")],1),t._v(" for that, or go to the Azure portal and access the online version.")]),t._v(" "),a("p",[t._v("We only want to give a quick look, so let's use the online version:")]),t._v(" "),a("tabs",{attrs:{options:{useUrlFragment:!1}}},[a("tab",{attrs:{name:"With a trial Cosmos DB account"}},[a("ol",[a("li",[a("p",[t._v("Open the "),a("a",{attrs:{href:"https://azure.microsoft.com/try/cosmosdb/?WT.mc_id=nitro-workshop-yolasors",target:"_blank",rel:"noopener noreferrer"}},[t._v("Try CosmosDB for free"),a("OutboundLink")],1),t._v(" website again, and click on the button "),a("strong",[t._v("Open in Azure Portal")]),t._v(":")]),t._v(" "),a("p",[a("img",{attrs:{src:e(211),alt:"open in Azure Portal button"}})])]),t._v(" "),a("li",[a("p",[t._v("Click on "),a("strong",[t._v("Storage Explorer")]),t._v(" in the resource menu, then unfold the "),a("code",[t._v("funpets-db")]),t._v(" database and "),a("code",[t._v("stories")]),t._v(" collection to open the "),a("strong",[t._v("Documents")]),t._v(" where your data lives in:")]),t._v(" "),a("p",[a("img",{attrs:{src:e(253),alt:"storage explorer"}})])])])]),t._v(" "),a("tab",{attrs:{name:"With your own Cosmos DB account"}},[a("ol",[a("li",[a("p",[t._v("Open "),a("a",{attrs:{href:"https://portal.azure.com?WT.mc_id=nitro-workshop-yolasors",target:"_blank",rel:"noopener noreferrer"}},[t._v("portal.azure.com"),a("OutboundLink")],1)])]),t._v(" "),a("li",[a("p",[t._v("Use the search bar at the top and enter the name of the Cosmos DB account you created, then click on it in the search results:")]),t._v(" "),a("p",[a("img",{attrs:{src:e(254),alt:"searching your Cosmos DB account"}})])]),t._v(" "),a("li",[a("p",[t._v("Click on "),a("strong",[t._v("Storage Explorer")]),t._v(" in the resource menu, then unfold the "),a("code",[t._v("funpets-db")]),t._v(" database and "),a("code",[t._v("stories")]),t._v(" collection to open the "),a("strong",[t._v("Documents")]),t._v(" where your data lives in:")]),t._v(" "),a("p",[a("img",{attrs:{src:e(255),alt:"storage explorer"}})])])])])],1),t._v(" "),a("p",[t._v("From there, you can query your stories, edit or delete them and even create new ones.\nThis tool can be helpful to quickly check your data visually and debug things when something's wrong.")]),t._v(" "),a("h2",{attrs:{id:"redeploy"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redeploy"}},[t._v("#")]),t._v(" Redeploy")]),t._v(" "),a("p",[t._v("Now that everything works locally, let's deploy your latest changes:")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Build your app")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" run build\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Create an archive from your local files and publish it")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Don't forget to change the name with the one you used previously")]),t._v("\nfunc azure functionapp publish funpets-api "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --nozip "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --publish-local-settings\n")])])]),a("p",[t._v("Notice that this time we added the "),a("code",[t._v("--publish-local-settings")]),t._v(" option to update the")]),t._v(" "),a("p",[t._v("Then invoke one of the newer API to check that deployment went fine:")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" https://"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("your-funpets-api"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(".azurewebsites.net/api/stories\n")])])]),a("br"),t._v(" "),a("hr"),t._v(" "),a("p",[a("strong",[t._v("Solution:")]),t._v(" see the "),a("a",{attrs:{href:"https://github.com/nitro-stack/nitro-workshop/tree/step3",target:"_blank",rel:"noopener noreferrer"}},[t._v("code for step 3"),a("OutboundLink")],1)])],1)}),[],!1,null,null,null);s.default=n.exports}}]);