(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{246:function(e,t,o){e.exports=o.p+"assets/img/thats-it.fb910f3b.jpg"},268:function(e,t,o){"use strict";o.r(t);var s=o(4),a=Object(s.a)({},(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"_2-deploy-application"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-deploy-application"}},[e._v("#")]),e._v(" 2. Deploy application")]),e._v(" "),s("p",[e._v("Before going further with our API, let's deploy it, serverless way!")]),e._v(" "),s("blockquote",[s("p",[e._v("But we haven't done anything meaningful yet, shouldn't we integrate all our features before deploying?")])]),e._v(" "),s("p",[e._v("Not at all! Deploying "),s("strong",[e._v("early")]),e._v(" and "),s("strong",[e._v("frequently")]),e._v(" is a factor of success in software development and a "),s("a",{attrs:{href:"https://azure.microsoft.com/overview/what-is-devops/?WT.mc_id=nitro-workshop-yolasors",target:"_blank",rel:"noopener noreferrer"}},[e._v("DevOps"),s("OutboundLink")],1),e._v(" best practice.")]),e._v(" "),s("h2",{attrs:{id:"go-serverless"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#go-serverless"}},[e._v("#")]),e._v(" Go serverless")]),e._v(" "),s("p",[e._v("Why serverless? Why not deploy our app using a container or a managed service, like "),s("a",{attrs:{href:"https://docs.microsoft.com/azure/app-service/?WT.mc_id=nitro-workshop-yolasors",target:"_blank",rel:"noopener noreferrer"}},[e._v("Azure App Service"),s("OutboundLink")],1),e._v(" for instance? There are 2 main reasons for that:")]),e._v(" "),s("ul",[s("li",[e._v("You only pay for what you use, not for the resource allocation (and it's "),s("a",{attrs:{href:"https://dev.to/azure/is-serverless-really-as-cheap-as-everyone-claims-4i9n",target:"_blank",rel:"noopener noreferrer"}},[e._v("dead cheap"),s("OutboundLink")],1),e._v(")")]),e._v(" "),s("li",[e._v("It scales automatically without any additional setup")])]),e._v(" "),s("p",[e._v("First, let's update our NestJS app into a serverless app so we can deploy it to "),s("a",{attrs:{href:"https://docs.microsoft.com/azure/azure-functions/?WT.mc_id=nitro-workshop-yolasors",target:"_blank",rel:"noopener noreferrer"}},[e._v("Azure Functions"),s("OutboundLink")],1),e._v(".")]),e._v(" "),s("div",{staticClass:"custom-block info"},[s("p",{staticClass:"custom-block-title"},[e._v("What's Azure Functions?")]),e._v(" "),s("p",[e._v("It's a solution for running small pieces of code, or "),s("em",[e._v("functions")]),e._v(", in the cloud. You just write the code for the problem at hand in your preferred language, without worrying about the infrastructure or enclosing app to run it.")])]),e._v(" "),s("p",[e._v("Open a terminal and run this command:")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[e._v("nest "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("add")]),e._v(" @nestjs/azure-func-http\n")])])]),s("p",[e._v("And... That's it. Really.")]),e._v(" "),s("p",[s("img",{attrs:{src:o(246),alt:"grandma looking surprised"}})]),e._v(" "),s("p",[e._v("Thanks to the included schematics, your server code is now ready to be deployed on Azure Functions. And the best part is that nothing was changed in your code, it can still run locally like previously.")]),e._v(" "),s("p",[e._v("If you take a closer look, here is what has been added:")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("main")]),e._v(": a folder containing the Azure Functions trigger config and entry point")]),e._v(" "),s("li",[s("code",[e._v("src/main.azure.ts")]),e._v(": an alternative entry point for your server app that will be used only on Azure Functions (thus leaving the regular entry point intact).")]),e._v(" "),s("li",[e._v("Some config files in the project's root, we do not need to care about them for now.")]),e._v(" "),s("li",[e._v("A new "),s("code",[e._v("start:azure")]),e._v(" NPM script in your "),s("code",[e._v("package.json")]),e._v(" file, allowing to run your API locally but with the Azure Functions simulator this time.")])]),e._v(" "),s("p",[e._v("To be able to use the command "),s("code",[e._v("npm run start:azure")]),e._v(", you must have installed the "),s("a",{attrs:{href:"https://docs.microsoft.com/azure/azure-functions/functions-run-local#v2?WT.mc_id=nitro-workshop-yolasors",target:"_blank",rel:"noopener noreferrer"}},[e._v("Azure Functions Core Tools"),s("OutboundLink")],1),e._v(" with the "),s("a",{attrs:{href:"/env"}},[e._v("prerequisites")]),e._v(". It will provide the "),s("code",[e._v("func")]),e._v(" CLI that you can use to test your functions and deploy them to Azure.")]),e._v(" "),s("p",[e._v("Now let's test our API running on a function:")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("npm")]),e._v(" run start:azure\n")])])]),s("p",[e._v("If everything is working well, at some point you should see this log in the console:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("Now listening on: http://0.0.0.0:7071\nApplication started. Press Ctrl+C to shut down.\n\nHttp Functions:\n\n        main:  http://localhost:7071/api/{*segments}\n")])])]),s("p",[e._v("That means that your API should be working on port "),s("code",[e._v("7071")]),e._v(", let's test it again using curl:")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" http://localhost:7071/api/stories/random\n")])])]),s("h2",{attrs:{id:"create-the-resources"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#create-the-resources"}},[e._v("#")]),e._v(" Create the resources")]),e._v(" "),s("p",[e._v("Now that your API is ready to run on Functions, let's deploy it to the real thing!")]),e._v(" "),s("p",[e._v("First, we have to create some Azure resources. For that we will use the Azure CLI commands:")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Login to Azure, should only be needed once")]),e._v("\naz login\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Create a new resource group")]),e._v("\naz group create --name funpets --location northeurope\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Create the storage account")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# This name must be globally unique, so change it with your own")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# /!\\ ONLY lowercase alphanumeric characters are allowed here /!\\")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# (no underscore or hyphen)")]),e._v("\naz storage account create --name "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("your-funpets-storage"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n                          --resource-group funpets "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n                          --kind StorageV2\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Create the function app")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# This name must be globally unique, so change it with your own")]),e._v("\naz functionapp create --name "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("your-funpets-api"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n                      --resource-group funpets "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n                      --consumption-plan-location northeurope "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n                      --storage-account "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("your-funpets-storage"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n")])])]),s("p",[e._v("The first thing we created is a "),s("a",{attrs:{href:"https://docs.microsoft.com/azure/azure-resource-manager/resource-group-overview?WT.mc_id=nitro-workshop-yolasors#resource-groups",target:"_blank",rel:"noopener noreferrer"}},[s("strong",[e._v("resource group")]),s("OutboundLink")],1),e._v(", a collection of Azure resources. It's typically used to group related resources for an application, by environment (production vs testing for example) or anything as needed.")]),e._v(" "),s("p",[e._v("Then we added a "),s("a",{attrs:{href:"https://docs.microsoft.com/azure/storage/common/storage-introduction?WT.mc_id=nitro-workshop-yolasors#azure-storage-services",target:"_blank",rel:"noopener noreferrer"}},[s("strong",[e._v("storage account")]),s("OutboundLink")],1),e._v(" that will be used to store our app data, files, and even application code.")]),e._v(" "),s("p",[e._v("Finally, we added a "),s("a",{attrs:{href:"https://docs.microsoft.com/azure/azure-functions/functions-overview?WT.mc_id=nitro-workshop-yolasors",target:"_blank",rel:"noopener noreferrer"}},[s("strong",[e._v("function app")]),s("OutboundLink")],1),e._v(" on which you will deploy your API.")]),e._v(" "),s("h2",{attrs:{id:"deploy-your-app"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#deploy-your-app"}},[e._v("#")]),e._v(" Deploy your app")]),e._v(" "),s("p",[e._v("To make deployment easier and faster for this workshop we will add a bit of specific configuration to your function app:")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Don't forget to change the name with your own")]),e._v("\naz functionapp config appsettings "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("set")]),e._v(" --name "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("your-funpets-api"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n                                      --resource-group funpets "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n                                      --settings "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"SCM_DO_BUILD_DURING_DEPLOYMENT=true"')]),e._v("\n")])])]),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[e._v("Important")]),e._v(" "),s("p",[e._v("Edit the "),s("code",[e._v(".funcignore")]),e._v(" file and add a line with "),s("code",[e._v("node_modules")]),e._v(" at the bottom.")])]),e._v(" "),s("p",[e._v("The "),s("code",[e._v("SCM_DO_BUILD_DURING_DEPLOYMENT=true")]),e._v(' setting will enable a "build" step for zip deployments, which for Node.js apps translates to '),s("code",[e._v("npm install")]),e._v(" being called on the server directly.\nThis way you don't have to package the required "),s("code",[e._v("node_modules")]),e._v(" with your app, reducing upload times a lot.")]),e._v(" "),s("p",[e._v("Now that we have the resources created and configured on Azure, we can use the "),s("code",[e._v("func")]),e._v(" CLI to deploy our API:")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Build your app")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("npm")]),e._v(" run build\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Create an archive from your local files and publish it")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Don't forget to change the name with the one you used previously")]),e._v("\nfunc azure functionapp publish "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("your-funpets-api"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" --nozip\n")])])]),s("p",[e._v("After publishing, you should see in the console the URL you can use to invoke the function, like this:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("Functions in funpets-api:\n    main - [httpTrigger]\n        Invoke url: https://<your-funpets-api>.azurewebsites.net/api/{*segments}\n")])])]),s("p",[e._v("We can invoke our trusty "),s("code",[e._v("curl")]),e._v(" command again to check the deployment using the previous URL:")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" https://"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("your-funpets-api"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(".azurewebsites.net/api/stories/random\n")])])]),s("p",[e._v("Server deployment, done ✔️.")]),e._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[e._v("Pro tip #1")]),e._v(" "),s("p",[e._v("When working on a production app, you should not deploy directly from your local source code, but rather connect your source code repository to a continuous integration and deployment system (CI/CD). You can either do that using "),s("a",{attrs:{href:"https://docs.microsoft.com/azure/devops-project/azure-devops-project-github?WT.mc_id=nitro-workshop-yolasors",target:"_blank",rel:"noopener noreferrer"}},[e._v("Azure DevOps"),s("OutboundLink")],1),e._v(" or directly connect your repository for deployment using this command:")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[e._v("az functionapp deployment "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("source")]),e._v(" config --name "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("your-funpets-api"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n                                        --resource-group funpets "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n                                        --repo-url "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("your-git-repo-url"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n")])])])]),e._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[e._v("Pro tip #2")]),e._v(" "),s("p",[e._v("For this workshop, we use the "),s("code",[e._v("--nozip")]),e._v(" option for deployment to disable the "),s("em",[e._v("Run-From-Package")]),e._v(" mode that runs the app directly from a read-only zip package. This is needed to run "),s("code",[e._v("npm install")]),e._v(" remotely thanks to the "),s("code",[e._v("SCM_DO_BUILD_DURING_DEPLOYMENT=true")]),e._v(" setting, to reduce upload times. But for production environments, you should avoid using that as your application startup time is slightly longer when "),s("code",[e._v("--nozip")]),e._v(" option is used.")])]),e._v(" "),s("br"),e._v(" "),s("hr"),e._v(" "),s("p",[s("strong",[e._v("Solution:")]),e._v(" see the "),s("a",{attrs:{href:"https://github.com/nitro-stack/nitro-workshop/tree/step2",target:"_blank",rel:"noopener noreferrer"}},[e._v("code for step 2"),s("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=a.exports}}]);