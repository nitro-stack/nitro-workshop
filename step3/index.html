<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>3. Add database | Nitro Workshop</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.3.0">
    <link rel="icon" href="/nitro-workshop/nitro.png">
  <meta name="theme-color" content="#0078d7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="msapplication-TileColor" content="#0078d7">
    <meta property="og:site_name" content="Nitro Workshop"><meta property="og:title" content="3. Add database"><meta property="og:description" content="Learn how to make Node.js serverless REST APIs with NestJS and Azure"><meta property="og:type" content="website"><meta property="og:url" content="https://nitro-stack.github.io/nitro-workshop/step3/"><meta property="og:image" content="https://nitro-stack.github.io/nitro-workshop/nitro.png"><meta name="twitter:title" content="3. Add database"><meta name="twitter:description" content="Learn how to make Node.js serverless REST APIs with NestJS and Azure"><meta name="twitter:url" content="https://nitro-stack.github.io/nitro-workshop/step3/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://nitro-stack.github.io/nitro-workshop/nitro.png"><meta name="twitter:label1" content="Written by"><meta name="twitter:data2" content="Yohan Lasorsa"><meta name="twitter:creator" content="@sinedied">
    <link rel="preload" href="/nitro-workshop/assets/css/0.styles.a1e28b27.css" as="style"><link rel="preload" href="/nitro-workshop/assets/js/app.72f1e144.js" as="script"><link rel="preload" href="/nitro-workshop/assets/js/2.37837671.js" as="script"><link rel="preload" href="/nitro-workshop/assets/js/3.f40463cd.js" as="script"><link rel="prefetch" href="/nitro-workshop/assets/js/10.2d5da0ed.js"><link rel="prefetch" href="/nitro-workshop/assets/js/11.5b590e3a.js"><link rel="prefetch" href="/nitro-workshop/assets/js/12.a176b819.js"><link rel="prefetch" href="/nitro-workshop/assets/js/13.f1264ff7.js"><link rel="prefetch" href="/nitro-workshop/assets/js/14.96d2f4bc.js"><link rel="prefetch" href="/nitro-workshop/assets/js/15.703b0f9c.js"><link rel="prefetch" href="/nitro-workshop/assets/js/16.8fd0dd7c.js"><link rel="prefetch" href="/nitro-workshop/assets/js/4.629eb8d2.js"><link rel="prefetch" href="/nitro-workshop/assets/js/5.6cf4e94b.js"><link rel="prefetch" href="/nitro-workshop/assets/js/6.d69e349b.js"><link rel="prefetch" href="/nitro-workshop/assets/js/7.1c6d1ffd.js"><link rel="prefetch" href="/nitro-workshop/assets/js/8.edd52f9a.js"><link rel="prefetch" href="/nitro-workshop/assets/js/9.f44a4e00.js">
    <link rel="stylesheet" href="/nitro-workshop/assets/css/0.styles.a1e28b27.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/nitro-workshop/" class="home-link router-link-active"><img src="/nitro-workshop/nitro.png" alt="Nitro Workshop" class="logo"> <span class="site-name can-hide">Nitro Workshop</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/nitro-workshop/" class="nav-link">Home</a></div><div class="nav-item"><a href="/nitro-workshop/intro.html" class="nav-link">Workshop</a></div><div class="nav-item"><a href="https://nitr.ooo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Nitro website
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/nitro-stack/nitro-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/nitro-workshop/" class="nav-link">Home</a></div><div class="nav-item"><a href="/nitro-workshop/intro.html" class="nav-link">Workshop</a></div><div class="nav-item"><a href="https://nitr.ooo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Nitro website
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/nitro-stack/nitro-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/nitro-workshop/intro.html" class="sidebar-link">Introduction</a></li><li><a href="/nitro-workshop/env.html" class="sidebar-link">0. Prerequisites</a></li><li><a href="/nitro-workshop/step1/" class="sidebar-link">1. Bootstrap project</a></li><li><a href="/nitro-workshop/step2/" class="sidebar-link">2. Deploy application</a></li><li><a href="/nitro-workshop/step3/" class="active sidebar-link">3. Add database</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nitro-workshop/step3/#configure-cosmos-db" class="sidebar-link">Configure Cosmos DB</a></li><li class="sidebar-sub-header"><a href="/nitro-workshop/step3/#integrate-with-nestjs" class="sidebar-link">Integrate with NestJS</a></li><li class="sidebar-sub-header"><a href="/nitro-workshop/step3/#create-an-entity" class="sidebar-link">Create an entity</a></li><li class="sidebar-sub-header"><a href="/nitro-workshop/step3/#inject-the-repository" class="sidebar-link">Inject the repository</a></li><li class="sidebar-sub-header"><a href="/nitro-workshop/step3/#add-new-endpoints" class="sidebar-link">Add new endpoints</a></li><li class="sidebar-sub-header"><a href="/nitro-workshop/step3/#test-your-endpoints" class="sidebar-link">Test your endpoints</a></li><li class="sidebar-sub-header"><a href="/nitro-workshop/step3/#explore-your-data" class="sidebar-link">Explore your data</a></li><li class="sidebar-sub-header"><a href="/nitro-workshop/step3/#redeploy" class="sidebar-link">Redeploy</a></li></ul></li><li><a href="/nitro-workshop/step4/" class="sidebar-link">4. Integrate file upload</a></li><li><a href="/nitro-workshop/step5/" class="sidebar-link">5. Extras</a></li><li><a href="/nitro-workshop/conclusion.html" class="sidebar-link">Conclusion</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_3-add-database"><a href="#_3-add-database" class="header-anchor">#</a> 3. Add database</h1> <p>Now that we have everything set up for our application code and deployment, we can go on with the more serious stuff and add a database instead of using hardcoded data.</p> <h2 id="configure-cosmos-db"><a href="#configure-cosmos-db" class="header-anchor">#</a> Configure Cosmos DB</h2> <p><a href="https://azure.microsoft.com/services/cosmos-db/?WT.mc_id=nitro-workshop-yolasors" target="_blank" rel="noopener noreferrer">Cosmos DB<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is a managed distributed NoSQL database that will allow you to save and retrieve data. It supports multiple data models and many well known database APIs, including <a href="https://www.mongodb.com/" target="_blank" rel="noopener noreferrer">MongoDB<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> that we will use for our application.</p> <p><img src="/nitro-workshop/assets/img/cosmos-db.f635c65e.png" alt="CosmosDB multi-model and different APIs illustration"></p> <p>First we have to create a Cosmos DB account, which can hold one or more databases.</p> <p>If you are attending this workshop with an instructor or if you are short on time, you should use the first option <strong>Use trial account</strong>. The second option allows you to create a new account, which is a bit longer.</p> <div class="tabs-component"><ul role="tablist" class="tabs-component-tabs"></ul> <div class="tabs-component-panels"><section aria-hidden="true" id="use-trial-account" role="tabpanel" class="tabs-component-panel" style="display:none;"><p>The quickest way to experiment with Cosmos DB is to use the <a href="https://azure.microsoft.com/try/cosmosdb/?WT.mc_id=nitro-workshop-yolasors" target="_blank" rel="noopener noreferrer">Try CosmosDB for free<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> website, to get instant access to a pre-provisionned free account for 30 days (renewable).</p> <ol><li><p>Open the <a href="https://azure.microsoft.com/try/cosmosdb/?WT.mc_id=nitro-workshop-yolasors" target="_blank" rel="noopener noreferrer">Try CosmosDB for free<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> website, then click on the MongoDB <strong>Create</strong> option:</p> <p><img src="/nitro-workshop/assets/img/try1.d2bea64c.png" alt="mongoDB database creation option"></p></li> <li><p>Log in if needed, then once the database is ready click on the button <strong>Open in Azure Portal</strong>:</p> <p><img src="/nitro-workshop/assets/img/try2.d2076d4c.png" alt="open in Azure Portal button"></p></li> <li><p>Click on the <strong>Data Explorer</strong> tab, then on the <strong>New Collection</strong> button:</p> <p><img src="/nitro-workshop/assets/img/try3.d40b54e3.png" alt="screenshot of data explorer"></p></li> <li><p>Fill in the fields like this:</p> <p><img src="/nitro-workshop/assets/img/try4.c954a03e.png" alt="screenshot of new collection creation"></p> <div class="custom-block tip"><p class="custom-block-title">Pro tip</p> <p>There are two things worth mentioning here:</p> <ul><li>We choose to share a provisioned throughput of <a href="https://docs.microsoft.com/azure/cosmos-db/request-units?WT.mc_id=nitro-workshop-yolasors" target="_blank" rel="noopener noreferrer">Request Units<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> among all our collections within our database, using the checkbox <code>Provision database throughput</code>. This greatly helps to reduce costs when using a paid account.</li> <li>We need to define a shard key (also called <a href="https://docs.microsoft.com/azure/cosmos-db/partitioning-overview?WT.mc_id=nitro-workshop-yolasors#choose-partitionkey" target="_blank" rel="noopener noreferrer">partition key<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>) for the collection, to ensure proper <a href="https://docs.microsoft.com/azure/cosmos-db/partitioning-overview?WT.mc_id=nitro-workshop-yolasors" target="_blank" rel="noopener noreferrer">partitioning<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. We use the default auto-generated <code>_id</code> property by MongoDB for that.</li></ul></div></li> <li><p>Finally, go to the <code>Connection strings</code> tab and click on the button next to your primary connection string to copy it:</p> <p><img src="/nitro-workshop/assets/img/try5.bd45ed70.png" alt="Screenshot of connection strings"></p></li></ol></section> <section aria-hidden="true" id="create-new-account" role="tabpanel" class="tabs-component-panel" style="display:none;"><div class="custom-block info"><p class="custom-block-title">Note</p> <p>There is now a Free Tier for Cosmos DB that includes 5 GB storage and up to 25 collections, with production-grade performance and no expiration period (it's <em>free forever</em>!). If you want to use it, you need to create your Cosmos DB account using the <a href="https://ms.portal.azure.com/?WT.mc_id=nitro-workshop-yolasors#create/Microsoft.DocumentDB" target="_blank" rel="noopener noreferrer">Azure Portal<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> instead of running the CLI command below (choose <strong>MongoDB</strong> for the API).</p></div> <p>We will use the Azure CLI command to create our new Cosmos DB account:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># Create a Cosmos DB account</span>
<span class="token comment"># This name must be globally unique, so change it with your own</span>
<span class="token comment"># This takes around ~10 min, so you can move on to the integration</span>
<span class="token comment"># step meanwhile</span>
az cosmosdb create --name <span class="token operator">&lt;</span>your-funpets-cosmos<span class="token operator">&gt;</span> <span class="token punctuation">\</span>
                   --resource-group funpets <span class="token punctuation">\</span>
                   --kind MongoDB
</code></pre></div><p>Once the account is created, we need do three more things before switching back to code:</p> <ol><li>Create the MongoDB database.</li></ol> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># Don't forget to change the account name with the one you used previously</span>
az cosmosdb mongodb database create --account-name <span class="token operator">&lt;</span>your-funpets-cosmos<span class="token operator">&gt;</span> <span class="token punctuation">\</span>
                                    --resource-group funpets <span class="token punctuation">\</span>
                                    --throughput <span class="token number">400</span> <span class="token punctuation">\</span>
                                    --name funpets-db
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Pro tip</p> <p>We choose to share a provisioned throughput of <a href="https://docs.microsoft.com/azure/cosmos-db/request-units?WT.mc_id=nitro-workshop-yolasors" target="_blank" rel="noopener noreferrer">Request Units<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> among all our collections within our database, using the <code>--throughput</code> option. This greatly helps to reduce costs.</p></div> <ol start="2"><li>Create the <code>stories</code> collection, where we will put our data.</li></ol> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># Don't forget to change the account name with the one you used previously</span>
az cosmosdb mongodb collection create --account-name <span class="token operator">&lt;</span>your-funpets-cosmos<span class="token operator">&gt;</span> <span class="token punctuation">\</span>
                                      --resource-group funpets <span class="token punctuation">\</span>
                                      --database-name funpets-db <span class="token punctuation">\</span>
                                      --name stories <span class="token punctuation">\</span>
                                      --shard _id
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Pro tip</p> <p>We need to define a shard key (also called <a href="https://docs.microsoft.com/azure/cosmos-db/partitioning-overview?WT.mc_id=nitro-workshop-yolasors#choose-partitionkey" target="_blank" rel="noopener noreferrer">partition key<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>) for the collection, to ensure proper <a href="https://docs.microsoft.com/azure/cosmos-db/partitioning-overview?WT.mc_id=nitro-workshop-yolasors" target="_blank" rel="noopener noreferrer">partitioning<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. We use the default auto-generated <code>_id</code> property by MongoDB for that.</p></div> <ol start="3"><li>Finally, we retrieve the connection string to connect our application to the database.</li></ol> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># Don't forget to change the account name with the one you used previously</span>
az cosmosdb keys list --name <span class="token operator">&lt;</span>your-funpets-cosmos<span class="token operator">&gt;</span> <span class="token punctuation">\</span>
                      --resource-group funpets <span class="token punctuation">\</span>
                      --type connection-strings <span class="token punctuation">\</span>
                      --query <span class="token string">&quot;connectionStrings[0].connectionString&quot;</span>
</code></pre></div></section></div></div> <p>Now edit the file <code>local.settings.json</code>, and add these properties to the <code>Values</code> list:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;MONGODB_CONNECTION_STRING&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;your primary connection string&gt;&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;MONGODB_DATABASE&quot;</span><span class="token operator">:</span> <span class="token string">&quot;funpets-db&quot;</span><span class="token punctuation">,</span>
</code></pre></div><p>Remove this line as it's not needed:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;AzureWebJobsStorage&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
</code></pre></div><p>These values will be exposed to our app as <strong>environment variables</strong> by the Functions runtime, to allow access to your database.</p> <h2 id="integrate-with-nestjs"><a href="#integrate-with-nestjs" class="header-anchor">#</a> Integrate with NestJS</h2> <p>You are now ready to use the database in your application. NestJS provides a great integration with <a href="https://typeorm.io" target="_blank" rel="noopener noreferrer">TypeORM<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> which is the most mature Object Relational Mapper (ORM) available for TypeScript, so we will use that.</p> <p>First, you have to install the a few more packages with this command:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">npm</span> <span class="token function">install</span> --save @nestjs/typeorm typeorm mongodb
</code></pre></div><p>Open the file <code>src/app.module.ts</code> and add <code>TypeOrmModule</code> to the module imports:</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    TypeOrmModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'mongodb'</span><span class="token punctuation">,</span>
      url<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MONGODB_CONNECTION_STRING</span><span class="token punctuation">,</span>
      database<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MONGODB_DATABASE</span><span class="token punctuation">,</span>
      entities<span class="token operator">:</span> <span class="token punctuation">[</span>
        __dirname <span class="token operator">+</span> <span class="token string">'/**/*.entity{.ts,.js}'</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      ssl<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      useUnifiedTopology<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      useNewUrlParser<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
  <span class="token punctuation">]</span>
</code></pre></div><p>Don't forget to add the missing import at the top:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> TypeOrmModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Pro tip</p> <p>Using <code>process.env.&lt;VARIABLE_NAME&gt;</code> in place of hardcoded values allows to keep sensitive informations out of your code base and read them from environment variables instead. This also allows you to deploy the exact same code on different environments (like staging and production for example), but with different configurations, as recommend in the <a href="https://12factor.net/config" target="_blank" rel="noopener noreferrer">12-factor app<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> best practices.</p></div> <p>TypeORM will discover and map your entities following the <code>*.entity.ts</code> (<code>.js</code> once compiled) naming scheme, as specified in the module options.</p> <p>But hey, we don't have an entity yet? That's right, let's create it!</p> <h2 id="create-an-entity"><a href="#create-an-entity" class="header-anchor">#</a> Create an entity</h2> <p>A database entity is used to model the properties of whatever object you would like to store. In our case, we would like to store fun pets stories, so let's create define a <code>Story</code> entity.</p> <p>Create a new file <code>src/stories/story.entity.ts</code> with this code:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Entity<span class="token punctuation">,</span> ObjectID<span class="token punctuation">,</span> ObjectIdColumn<span class="token punctuation">,</span> Column <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token string">'stories'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Story</span> <span class="token punctuation">{</span>
  @<span class="token function">ObjectIdColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> id<span class="token operator">:</span> ObjectID<span class="token punctuation">;</span>
  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> animal<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> description<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> imageUrl<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span> createdAt<span class="token operator">:</span> Date<span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter">story<span class="token operator">?</span><span class="token operator">:</span> Partial<span class="token operator">&lt;</span>Story<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> story<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now let's break down the annotations we have used:</p> <ul><li><code>@Entity</code> marks the class as a TypeORM entity to be stored into the <code>stories</code> collection.</li> <li><code>@ObjectIdColumn</code> marks the unique identifier of an entity that will be mapped to the mandatory MongoDB <code>_id</code> property. It will be automatically generated if you don't provide one.</li> <li><code>@Column</code> marks the properties you want to map to a table column. The type of property will also define the type of data that will be stored.</li></ul> <div class="custom-block info"><p class="custom-block-title">Note</p> <p>For more complex domain models you can define subdocuments using simple type references, see <a href="https://typeorm.io/#/mongodb/defining-subdocuments-embed-documents" target="_blank" rel="noopener noreferrer">this example<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for usage information.</p></div> <h2 id="inject-the-repository"><a href="#inject-the-repository" class="header-anchor">#</a> Inject the repository</h2> <p>TypeORM supports the <a href="https://docs.microsoft.com/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design?WT.mc_id=nitro-workshop-yolasors#the-repository-pattern" target="_blank" rel="noopener noreferrer">repository design pattern<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, and <code>@nestjs/typeorm</code> package provides you an easy way to declare repositories you can inject for each of your entities.</p> <p>Open the file <code>src/app.module.ts</code> again and add this to the module imports:</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    TypeOrmModule<span class="token punctuation">.</span><span class="token function">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Story<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
  <span class="token punctuation">]</span>
</code></pre></div><p>Now you can inject your <code>Story</code> repository using the annotation <code>@InjectRepository</code>. Open the file <code>src/stories/stories.controller.ts</code> and add this constructor:</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'stories'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">StoriesController</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    <span class="token parameter">@<span class="token function">InjectRepository</span><span class="token punctuation">(</span>Story<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> storiesRepository<span class="token operator">:</span> MongoRepository<span class="token operator">&lt;</span>Story<span class="token operator">&gt;</span><span class="token punctuation">,</span></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Don't forget to add these missing imports at the top of the file:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> MongoRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ObjectID <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'mongodb'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Story <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./story.entity'</span><span class="token punctuation">;</span>
</code></pre></div><p>You can now use <code>this.storiesRepositoy</code> within your controller to perform CRUD operations:</p> <ul><li><code>save(entity: PartialEntity&lt;Entity&gt; | PartialEntity&lt;Entity&gt;[], options?: SaveOptions): Promise&lt;Entity | Entity[]&gt;</code>: inserts one or more entities in the database if they do not exists, updates otherwise.</li> <li><code>findOne(criteria?: ObjectID | FindOneOptions&lt;Entity&gt;): Promise&lt;Entity | undefined&gt;</code>: finds the first entity matching an ID or query options.</li> <li><code>find(criteria?: FindManyOptions&lt;Entity&gt;): Promise&lt;Entity[]&gt;</code>: finds all entities that match the specified criteria (return all entities if none is provided).</li> <li><code>update(criteria: ObjectID | ObjectID[] | FindConditions&lt;Entity&gt;, partialEntity: PartialEntity&lt;Entity&gt; | PartialEntity&lt;Entity&gt;[]): Promise&lt;UpdateResult&gt;</code>: updates entities matching the specified criteria. It allows partial updates, but does not check if entities exists.</li> <li><code>delete(criteria: ObjectID | ObjectID[] | FindConditions&lt;Entity&gt;): Promise&lt;DeleteResult&gt;</code>: removes one or more entities matching the specified criteria from the database. Does not check if entities exists.</li></ul> <p>In all these methods, you can either use the entity ID or a regular <a href="https://docs.mongodb.com/manual/tutorial/query-documents/" target="_blank" rel="noopener noreferrer">MongoDB query<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to match specific entities. For example, you can use:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// Find all cats stories</span>
<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storiesRepository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> animal<span class="token operator">:</span> <span class="token string">'cat'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Find the story with the specified ID</span>
<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storiesRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="add-new-endpoints"><a href="#add-new-endpoints" class="header-anchor">#</a> Add new endpoints</h2> <p>Now you have everything needed to create new endpoints to create and get stories:</p> <div class="language- extra-class"><pre class="language-text"><code>GET /stories/:id  // Get the story with the specified ID
GET /stories      // Get all stories
POST /stories     // Create a new story
</code></pre></div><p>Let's start with the first one, to retrieve a single story using its ID.
Add this method to your controller:</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">getStory</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Story<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> story <span class="token operator">=</span> ObjectID<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storiesRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>story<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Entity not found</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> story<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We use the <code>@Get()</code> annotation like in <a href="/nitro-workshop/step1.html#Add-your-first-endpoint">Step 1</a>, but this time we add a <a href="https://docs.nestjs.com/controllers#route-parameters" target="_blank" rel="noopener noreferrer">route parameter<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> using <code>:id</code>.
This parameter can then be retrieved with the function arguments using the <code>@Param('id')</code> annotation.</p> <p>Then we call the <code>storiesRepository.findOne()</code> method to find the matching entity. In case it's not found or if provided ID is invalid, we return a status <code>404</code> error using NestJS predefined exception class <code>NotFoundException</code>.</p> <p>After that, it's time for you to work a bit by yourself to add the 2 remaining endpoints 😉.</p> <div class="custom-block tip"><p class="custom-block-title">Note</p> <p>For the create endpoint, if the property <code>createdAt</code> is not set, it should be added with the current date.</p></div> <p>If you're stuck, you may find some help in the <a href="https://docs.nestjs.com/controllers#full-resource-sample" target="_blank" rel="noopener noreferrer">NestJS documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and the <a href="https://typeorm.io/#/repository-api/repository-api" target="_blank" rel="noopener noreferrer">TypeORM documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h2 id="test-your-endpoints"><a href="#test-your-endpoints" class="header-anchor">#</a> Test your endpoints</h2> <p>After you finished adding the new endpoints, start your server using the functions emulator:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">npm</span> run start:azure
</code></pre></div><p>When the server is started, you can test if your new endpoints behave correctly using <code>curl</code>:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> http://localhost:7071/api/stories
<span class="token comment"># should return an empty list: []</span>

<span class="token function">curl</span> http://localhost:7071/api/stories/0
<span class="token comment"># should return 404 with an error</span>

<span class="token function">curl</span> http://localhost:7071/api/stories <span class="token punctuation">\</span>
  -X POST <span class="token punctuation">\</span>
  -H <span class="token string">&quot;content-type: application/json&quot;</span> <span class="token punctuation">\</span>
  -d <span class="token string">'{ &quot;animal&quot;: &quot;cat&quot;, &quot;description&quot;: &quot;Cats have supersonic hearing&quot; }'</span>
<span class="token comment"># should return the newly created story</span>

<span class="token function">curl</span> http://localhost:7071/api/stories
<span class="token comment"># should return a list with the previously added story</span>

<span class="token function">curl</span> http://localhost:7071/api/stories/<span class="token operator">&lt;</span>id_from_post_command<span class="token operator">&gt;</span>
<span class="token comment"># should return this single story</span>
</code></pre></div><h2 id="explore-your-data"><a href="#explore-your-data" class="header-anchor">#</a> Explore your data</h2> <p>As you should have created some stories at this point, why not take a look at the data you have directly in the database?</p> <p>You can either use the standalone <a href="https://azure.microsoft.com/features/storage-explorer/?WT.mc_id=nitro-workshop-yolasors" target="_blank" rel="noopener noreferrer">Storage Explorer application<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for that, or go to the Azure portal and access the online version.</p> <p>We only want to give a quick look, so let's use the online version:</p> <div class="tabs-component"><ul role="tablist" class="tabs-component-tabs"></ul> <div class="tabs-component-panels"><section aria-hidden="true" id="with-a-trial-cosmos-db-account" role="tabpanel" class="tabs-component-panel" style="display:none;"><ol><li><p>Open the <a href="https://azure.microsoft.com/try/cosmosdb/?WT.mc_id=nitro-workshop-yolasors" target="_blank" rel="noopener noreferrer">Try CosmosDB for free<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> website again, and click on the button <strong>Open in Azure Portal</strong>:</p> <p><img src="/nitro-workshop/assets/img/try2.d2076d4c.png" alt="open in Azure Portal button"></p></li> <li><p>Click on <strong>Storage Explorer</strong> in the resource menu, then unfold the <code>funpets-db</code> database and <code>stories</code> collection to open the <strong>Documents</strong> where your data lives in:</p> <p><img src="/nitro-workshop/assets/img/try-explorer.9ef0237a.png" alt="storage explorer"></p></li></ol></section> <section aria-hidden="true" id="with-your-own-cosmos-db-account" role="tabpanel" class="tabs-component-panel" style="display:none;"><ol><li><p>Open <a href="https://portal.azure.com?WT.mc_id=nitro-workshop-yolasors" target="_blank" rel="noopener noreferrer">portal.azure.com<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p>Use the search bar at the top and enter the name of the Cosmos DB account you created, then click on it in the search results:</p> <p><img src="/nitro-workshop/assets/img/cosmos-portal.dba52ccd.png" alt="searching your Cosmos DB account"></p></li> <li><p>Click on <strong>Storage Explorer</strong> in the resource menu, then unfold the <code>funpets-db</code> database and <code>stories</code> collection to open the <strong>Documents</strong> where your data lives in:</p> <p><img src="/nitro-workshop/assets/img/cosmos-explorer.2c355978.png" alt="storage explorer"></p></li></ol></section></div></div> <p>From there, you can query your stories, edit or delete them and even create new ones.
This tool can be helpful to quickly check your data visually and debug things when something's wrong.</p> <h2 id="redeploy"><a href="#redeploy" class="header-anchor">#</a> Redeploy</h2> <p>Now that everything works locally, let's deploy your latest changes:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># Build your app</span>
<span class="token function">npm</span> run build

<span class="token comment"># Create an archive from your local files and publish it</span>
<span class="token comment"># Don't forget to change the name with the one you used previously</span>
func azure functionapp publish funpets-api <span class="token punctuation">\</span>
  --nozip <span class="token punctuation">\</span>
  --publish-local-settings
</code></pre></div><p>Notice that this time we added the <code>--publish-local-settings</code> option to update the</p> <p>Then invoke one of the newer API to check that deployment went fine:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> https://<span class="token operator">&lt;</span>your-funpets-api<span class="token operator">&gt;</span>.azurewebsites.net/api/stories
</code></pre></div><br> <hr> <p><strong>Solution:</strong> see the <a href="https://github.com/nitro-stack/nitro-workshop/tree/step3" target="_blank" rel="noopener noreferrer">code for step 3<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/nitro-workshop/step2/" class="prev">2. Deploy application</a></span> <span class="next"><a href="/nitro-workshop/step4/">4. Integrate file upload</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/nitro-workshop/assets/js/app.72f1e144.js" defer></script><script src="/nitro-workshop/assets/js/2.37837671.js" defer></script><script src="/nitro-workshop/assets/js/3.f40463cd.js" defer></script>
  </body>
</html>
