<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>5. Extras | Nitro workshop</title>
    <meta name="description" content="Learn how to make Node.js serverless REST APIs with NestJS and Azure">
    <link rel="icon" href="/nitro-workshop/nitro.png">
  <meta name="theme-color" content="#0078d7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="msapplication-TileColor" content="#0078d7">
    <meta property="og:image" content="https://nitro-stack.github.io/nitro-workshop/nitro.png"><meta name="twitter:image" content="https://nitro-stack.github.io/nitro-workshop/nitro.png"><meta property="og:description" content="Learn how to make Node.js serverless REST APIs with NestJS and Azure"><meta name="twitter:description" content="Learn how to make Node.js serverless REST APIs with NestJS and Azure"><meta itemprop="description" content="Learn how to make Node.js serverless REST APIs with NestJS and Azure"><meta property="og:url" content="https://nitro-stack.github.io/nitro-workshop/step5.html"><meta name="twitter:url" content="https://nitro-stack.github.io/nitro-workshop/step5.html"><meta property="og:title" content="5. Extras"><meta name="twitter:title" content="5. Extras"><meta itemprop="name" content="5. Extras"><meta property="og:type" content="website"><meta name="twitter:card" content="summary"><meta property="og:site_name" content="Nitro Workshop"><meta name="twitter:site" content="@sinedied"><meta name="twitter:creator" content="@sinedied">
    <link rel="preload" href="/nitro-workshop/assets/css/0.styles.50f1f6e2.css" as="style"><link rel="preload" href="/nitro-workshop/assets/js/app.a8c672b0.js" as="script"><link rel="preload" href="/nitro-workshop/assets/js/3.479d6eb7.js" as="script"><link rel="preload" href="/nitro-workshop/assets/js/2.530f1a9a.js" as="script"><link rel="preload" href="/nitro-workshop/assets/js/11.fe483f38.js" as="script"><link rel="preload" href="/nitro-workshop/assets/js/5.22983426.js" as="script"><link rel="prefetch" href="/nitro-workshop/assets/js/10.d965d8f4.js"><link rel="prefetch" href="/nitro-workshop/assets/js/12.e615794a.js"><link rel="prefetch" href="/nitro-workshop/assets/js/13.7be9de47.js"><link rel="prefetch" href="/nitro-workshop/assets/js/14.aabe62ca.js"><link rel="prefetch" href="/nitro-workshop/assets/js/15.b68a732d.js"><link rel="prefetch" href="/nitro-workshop/assets/js/16.8be28db5.js"><link rel="prefetch" href="/nitro-workshop/assets/js/4.8804fbfd.js"><link rel="prefetch" href="/nitro-workshop/assets/js/6.4f86e07c.js"><link rel="prefetch" href="/nitro-workshop/assets/js/7.80ed88e3.js"><link rel="prefetch" href="/nitro-workshop/assets/js/8.6f679d49.js"><link rel="prefetch" href="/nitro-workshop/assets/js/9.aff70da2.js">
    <link rel="stylesheet" href="/nitro-workshop/assets/css/0.styles.50f1f6e2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/nitro-workshop/" class="home-link router-link-active"><img src="/nitro-workshop/nitro.png" alt="Nitro workshop" class="logo"> <span class="site-name can-hide">Nitro workshop</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/nitro-workshop/" class="nav-link">Home</a></div><div class="nav-item"><a href="/nitro-workshop/intro.html" class="nav-link">Workshop</a></div><div class="nav-item"><a href="https://nitr.ooo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Nitro website
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/nitro-stack/nitro-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/nitro-workshop/" class="nav-link">Home</a></div><div class="nav-item"><a href="/nitro-workshop/intro.html" class="nav-link">Workshop</a></div><div class="nav-item"><a href="https://nitr.ooo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Nitro website
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/nitro-stack/nitro-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/nitro-workshop/intro.html" class="sidebar-link">Introduction</a></li><li><a href="/nitro-workshop/env.html" class="sidebar-link">0. Prerequisites</a></li><li><a href="/nitro-workshop/step1/" class="sidebar-link">1. Bootstrap project</a></li><li><a href="/nitro-workshop/step2/" class="sidebar-link">2. Deploy application</a></li><li><a href="/nitro-workshop/step3/" class="sidebar-link">3. Add database</a></li><li><a href="/nitro-workshop/step4/" class="sidebar-link">4. Integrate file upload</a></li><li><a href="/nitro-workshop/step5/" class="active sidebar-link">5. Extras</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nitro-workshop/step5/#add-data-validation" class="sidebar-link">Add data validation</a></li><li class="sidebar-sub-header"><a href="/nitro-workshop/step5/#enable-cors" class="sidebar-link">Enable CORS</a></li><li class="sidebar-sub-header"><a href="/nitro-workshop/step5/#set-authorization-level" class="sidebar-link">Set authorization level</a></li><li class="sidebar-sub-header"><a href="/nitro-workshop/step5/#write-tests" class="sidebar-link">Write tests</a></li></ul></li><li><a href="/nitro-workshop/conclusion.html" class="sidebar-link">Conclusion</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_5-extras"><a href="#_5-extras" class="header-anchor">#</a> 5. Extras</h1> <p>At this point, you already have a working full-featured serverless API, well done! üéâ</p> <p>NestJS is a very comprehensive framework, and there could be a lot more use-cases to cover for your specific needs. I encourage you to dive into the <a href="https://docs.nestjs.com/" target="_blank" rel="noopener noreferrer">NestJS documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to learn more about the techniques and tools you can use.</p> <p>If you have more time and feel like it, here are some extras points that I found interesting to cover, especially if you want to build enterprise apps.</p> <p>Note that each of these extra parts is entirely independent, so you can skip to the one you are the most interested in or do them in any order üòâ.</p> <h2 id="add-data-validation"><a href="#add-data-validation" class="header-anchor">#</a> Add data validation</h2> <p>It is a best practice to check and validate any data received by an API.
What do you think would happen if you call your story creation endpoint, but without providing data?</p> <p>Let's try!</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> http://localhost:7071/api/stories -X POST -d <span class="token string">&quot;&quot;</span>
</code></pre></div><p>Whoops! A new story is created, but with our entity properties are left empty üò±.</p> <p>We might want to make sure a new story has its <code>animal</code> field set and either a <code>description</code> or an image provided.</p> <p>Nest.js provides a built-in <code>ValidationPipe</code> that enforces validation rules for received data payloads, thanks to annotations provided by the <a href="https://github.com/typestack/class-validator" target="_blank" rel="noopener noreferrer"><code>class-validator</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> package.</p> <p>To use it, you have to create a DTO (<a href="https://en.wikipedia.org/wiki/Data_transfer_object" target="_blank" rel="noopener noreferrer">Data Transfer Object<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>) class on which you will declare the validations rules using annotations.</p> <p>First, you need to install the required packages:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">npm</span> <span class="token function">install</span> class-validator class-transformer
</code></pre></div><p>Then create the file <code>src/stories/story.dto.ts</code>:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">StoryDto</span> <span class="token punctuation">{</span>
  @<span class="token function">IsNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  animal<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  
  @<span class="token function">IsOptional</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  description<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  
  @<span class="token function">IsOptional</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  createdAt<span class="token punctuation">:</span> Date<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>It looks like a lot like our <code>Story</code> entity, but this time you define only properties that are expected in the request payload. That's why there is no <code>imageUrl</code> property here: it will be set by the controller only if an image file is uploaded.</p> <p>The annotations <code>@IsNotEmpty()</code> and <code>@IsOptional()</code> describe which property can be omitted and which one can be set in the payload. You can see the complete list of provided decorators <a href="https://github.com/typestack/class-validator#validation-decorators" target="_blank" rel="noopener noreferrer">here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>Now open <code>src/stories/stories.controller.ts</code> and change the type of the <code>data</code> parameter of your <code>POST</code> function to <code>StoryDto</code>:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token operator">...</span>
<span class="token keyword">async</span> <span class="token function">createStory</span><span class="token punctuation">(</span>
  @<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  data<span class="token punctuation">:</span> StoryDto<span class="token punctuation">,</span>
  @<span class="token function">UploadedFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  file<span class="token punctuation">:</span> UploadedFileMetadata<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Story<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
<span class="token operator">...</span>
</code></pre></div><p>Finally open <code>src/main.azure.ts</code> and enable <code>ValidationPipe</code> at the application level, to ensure all endpoints gets data validation:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>AppModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">setGlobalPrefix</span><span class="token punctuation">(</span><span class="token string">'api'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">useGlobalPipes</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValidationPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Start your server with <code>npm run start:azure</code> and run the previous <code>curl</code> command again. This time you should properly receive an HTTP error <code>400</code> (bad request).</p> <div class="custom-block tip"><p class="custom-block-title">Pro tip</p> <p>By default, detailed error messages will be automatically generated in case of a validation error. You also specify custom error message in the decorator options, for example:</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">IsNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">'animal must not be empty'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
animal<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</code></pre></div><p>You also use special tokens in your error message or use a function for better granularity. See the <a href="https://github.com/typestack/class-validator#validation-messages" target="_blank" rel="noopener noreferrer"><code>class-validator</code> documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for more details.</p></div> <p>What about our other constraint, which is to have either a <code>description</code> or an image file provided?</p> <p>Since the <code>imageUrl</code> information is not directly part of the DTO, we cannot use it for validation. As the <code>imageUrl</code> property is set in the controller, that's where you have to perform manual validation. You can use the <a href="https://github.com/typestack/class-validator#manual-validation" target="_blank" rel="noopener noreferrer">manual validation methods<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> of the <code>class-validator</code> package for that.</p> <p>This time, it's your turn to finish the job!</p> <ul><li>Ensure that either <code>description</code> or <code>imageUrl</code> is not empty, using manual validation.</li> <li>Ensure that <code>description</code> length is at most 240 characters.</li> <li>Ensure that <code>animal</code> is either set to <code>cat</code>, <code>doc</code> or <code>hamster</code> using annotations.</li> <li>Ensure that <code>createdAt</code> is a date if provided, using annotations.</li></ul> <p>You can read more on data validation techniques in the <a href="https://docs.nestjs.com/techniques/validation" target="_blank" rel="noopener noreferrer">NestJS documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h2 id="enable-cors"><a href="#enable-cors" class="header-anchor">#</a> Enable CORS</h2> <p>If you try to access your API inside a web application from your browser, you might encounter an error like that one:</p> <p><img src="/nitro-workshop/assets/img/cors-error.8f5afbe2.jpg" alt="CORS error"></p> <p>This error occurs because browsers block HTTP requests from scripts to web domains different than the one of the current web page to improve security.</p> <p>To bypass this restriction, your server must define specific HTTP headers to allow it. This mechanism is called <a href="https://developer.mozilla.org/docs/Web/HTTP/CORS" target="_blank" rel="noopener noreferrer">Cross-Origin Resource Sharing<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (CORS).</p> <p>CORS is already enabled by default on Azure Functions but you must add your website domain to the list of allowed origins using this command:</p> <div class="language- extra-class"><pre class="language-text"><code># Don't forget to change the name and URL with your own
$ az functionapp cors add \
    --name funpets-api \
    --resource-group funpets \
    --allowed-origins https://yourwebsite.com
</code></pre></div><p>If you want to allow any website to use your API, you can replace the website URL by using <code>*</code> instead. In that case, be careful as Azure Functions will auto-scale to handle the workload if millions of users starts using it, but so will your bill!</p> <h2 id="set-authorization-level"><a href="#set-authorization-level" class="header-anchor">#</a> Set authorization level</h2> <p>By default, all Azure Functions triggered by HTTP are publicly available. It's useful for a lot of scenarios, but at some point you might want to restrict who can execute your functions, in our case your API.</p> <p>Open the file <code>main/function.json</code>. In the functions, bindings, notice that <code>authLevel</code> is set to <code>anonymous</code>. It can be set to one of these 3 values:</p> <ul><li><code>anonymous</code>: no API key is required (default).</li> <li><code>function</code>: an API key specific to this function is required. If none is defined, the <code>default</code> one will be used.</li> <li><code>admin</code>: an host API key is required. It will be shared among all functions from the same app.</li></ul> <p>Now change <code>authLevel</code> to <code>function</code>, and redeploy your function:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># Don't forget to change the name with the one you used previously</span>
func azure functionapp publish funpets-api --nozip
</code></pre></div><p>Then try to invoke again your API:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> https://<span class="token operator">&lt;</span>your-funpets-api<span class="token operator">&gt;</span>.azurewebsites.net/api/stories -i
</code></pre></div><p>You should get an HTTP status <code>401</code> error (<code>Unauthorized</code>).</p> <p>To call a protected function, you need to either provide the key as a query string parameter in the form <code>code=&lt;api_key&gt;</code> or you can provide it with the HTTP header <code>x-functions-key</code>.</p> <p>You can either log in to <a href="https://portal.azure.com" target="_blank" rel="noopener noreferrer">portal.azure.com<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and go to your function app, or follow these steps to retrieve your function API keys:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>// Retrieve your resource ID
<span class="token comment"># Don't forget to change the name with the one you used previously</span>
az functionapp show --resource-group funpets <span class="token punctuation">\</span>
                    --name funpets-api <span class="token punctuation">\</span>
                    --query <span class="token function">id</span>

<span class="token comment"># Use the resource ID from the previous command</span>
az rest --method post --uri <span class="token string">&quot;&lt;resource_id&gt;/host/default/listKeys?api-version=2018-11-01&quot;</span>
</code></pre></div><p>You should see something like that:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;functionKeys&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;default&quot;</span><span class="token operator">:</span> <span class="token string">&quot;functionApiKey==&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;masterKey&quot;</span><span class="token operator">:</span> <span class="token string">&quot;masterApiKey==&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;systemKeys&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Then try to invoke again your API, this time with the <code>x-functions-key</code> header set with your function API key:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> https://<span class="token operator">&lt;</span>your-funpets-api<span class="token operator">&gt;</span>.azurewebsites.net/api/stories -i <span class="token punctuation">\</span>
  -H <span class="token string">&quot;x-functions-key: &lt;your_function_api_key&gt;&quot;</span>
</code></pre></div><p>This time the call should succeed!</p> <p>Using authorization level you can restrict who can call your API, this can be useful especially for service-to-service access restrictions.</p> <p>However, if you need to manage finely who can access your API with an endpoint granularity, you need to implement <a href="https://docs.nestjs.com/techniques/authentication" target="_blank" rel="noopener noreferrer">authentication<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> in your app.</p> <h2 id="write-tests"><a href="#write-tests" class="header-anchor">#</a> Write tests</h2> <p>Automated testing is a fundamental requirement to develop robust software applications. It helps catching bugs early, preventing regressions and ensuring that production releases meet your quality and performance goals.</p> <p>TODO:</p> <p>https://docs.nestjs.com/fundamentals/testing</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ‚Üê
      <a href="/nitro-workshop/step4/" class="prev">4. Integrate file upload</a></span> <span class="next"><a href="/nitro-workshop/conclusion.html">Conclusion</a>
      ‚Üí
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/nitro-workshop/assets/js/app.a8c672b0.js" defer></script><script src="/nitro-workshop/assets/js/3.479d6eb7.js" defer></script><script src="/nitro-workshop/assets/js/2.530f1a9a.js" defer></script><script src="/nitro-workshop/assets/js/11.fe483f38.js" defer></script><script src="/nitro-workshop/assets/js/5.22983426.js" defer></script>
  </body>
</html>
